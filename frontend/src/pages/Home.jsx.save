import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import DataTable from '../components/DataTable'
import './Home.css'

// Base URL for the backend API. When running under Docker Compose the
// environment variable is provided by the compose file. Fallback to a
// relative path so the frontend can be served without configuration.
//const API_BASE = import.meta.env.VITE_API_URL || ''
const API_BASE = 
const PAGE_SIZE = 20

function TableWrapper({ endpoint }) {
  const navigate = useNavigate()
  const [rows, setRows] = useState([])

  const fetchPage = (p) => {
    fetch(`${API_BASE}${endpoint}?limit=${PAGE_SIZE}&offset=${(p - 1) * PAGE_SIZE}`)
      .then((res) => res.json())
      .then((json) => setRows(json.data || []))
      .catch(() => {})
  }

  useEffect(() => {
    fetchPage(1)
  }, [endpoint])

  const handleClick = (row) => {
    navigate(
      `/events/upload?event_id=${row['ID']}&patient_id=${row['Patient ID']}&date=${row['Date']}&criteria=${encodeURIComponent(row['Criteria'])}`
    )
  }
  return <DataTable rows={rows} onRowClick={handleClick} onPageChange={fetchPage} />
}

function Home() {
  const [rows, setRows] = useState([])
  const [statusSummary, setStatusSummary] = useState(null)
  const [search, setSearch] = useState('')

  useEffect(() => {
    fetch(`${API_BASE}/api/tables/events`)
      .then((res) => res.json())
      .then((json) => setRows(json.data || []))
      .catch(() => {})

    fetch(`${API_BASE}/api/events/status_summary`)
      .then((res) => res.json())
      .then((json) => setStatusSummary(json.data || null))
      .catch(() => {})
  }, [])

  // eslint-disable-next-line no-unused-vars
  const filteredRows = rows.filter((row) =>
    Object.values(row).some((v) =>
      String(v).toLowerCase().includes(search.toLowerCase())
    )
  )


  return (
    <div className="home-container">
      <h1>CNICS Validation</h1>
      <p>Welcome to the CNICS Validation application.</p>
      <p>
        Use this page to find an event and upload its packet. Please note the
        instructions on the right about how to properly assemble a review
        packet.
      </p>


      <section>
        <h3>Quick Search</h3>
        <input
          className="quick-search"
          type="text"
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          placeholder="Search"
        />
      </section>



      <section>
        <h3>Events That Need Packets</h3>
        <TableWrapper endpoint="/api/events/need_packets" />
      </section>

      <section>
        <h3>Event Packets for Your Review</h3>
        <TableWrapper endpoint="/api/events/for_review" />
      </section>

      {statusSummary && (
        <section>
          <h3>Event Status Summary</h3>
          <table className="data-table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
              {Object.entries(statusSummary).map(([status, count]) => (
                <tr key={status}>
                  <td>{status}</td>
                  <td>{count}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </section>
      )}

      <div className="infobox">
        <h3>Review packets should contain:</h3>
        <ol>
          <li>Physician's notes closest to potential Event date</li>
          <li>Outpatient cardiology consultations</li>
          <li>In-patient cardiology notes or consults</li>
          <li>Baseline ECG</li>
          <li>First 2 ECGs after admission or in-hospital event</li>
          <li>Related procedure and diagnostic test results</li>
          <li>Related laboratory evidence</li>
          <li>
            Please redact the personal identifiers including name, birthday, and
            hospital number
          </li>
        </ol>
        <div>
          Full instructions:{' '}
          <a href={`${API_BASE}/files/CNICS MI Review packet assembly instructions.doc`} download>.doc</a>{' '}
          |{' '}
          <a
            href={`${API_BASE}/files/CNICS MI Review packet assembly instructions.pdf`}
            target="_blank"
          >
            .pdf
          </a>
        </div>
      </div>

      <div className="infobox">
        <h3>Review Instructions:</h3>
        <div>
          View as:{' '}
          <a href={`${API_BASE}/files/CNICS MI reviewer instructions.doc`} download>.doc</a> |{' '}
          <a href={`${API_BASE}/files/CNICS MI reviewer instructions.pdf`} target="_blank">
            .pdf
          </a>
        </div>
      </div>

      <div className="infobox">
        <h3>Additional Documents:</h3>
        <ul>
          <li>
            <a href={`${API_BASE}/files/CNICS MI event scrubbing protocol.doc`} download>
              Event Scrubbing Protocol
            </a>
            {' | '}
            <a href={`${API_BASE}/files/CNICS MI event scrubbing protocol.pdf`} target="_blank">PDF</a>
          </li>
          <li>
            <a href={`${API_BASE}/files/CNICS VTE Review packet assembly instructions.doc`} download>
              VTE Packet Assembly Instructions
            </a>
            {' | '}
            <a href={`${API_BASE}/files/CNICS VTE Review packet assembly instructions.pdf`} target="_blank">PDF</a>
          </li>
          <li>
            <a href={`${API_BASE}/files/NA-ACCORD MI Review packet assembly instructions.doc`} download>
              NA-ACCORD Packet Assembly Instructions
            </a>
            {' | '}
            <a href={`${API_BASE}/files/NA-ACCORD MI Review packet assembly instructions.pdf`} target="_blank">PDF</a>
          </li>
          <li>
            <a href={`${API_BASE}/files/NA-ACCORD MI reviewer instructions.doc`} download>
              NA-ACCORD Reviewer Instructions
            </a>
            {' | '}
            <a href={`${API_BASE}/files/NA-ACCORD MI reviewer instructions.pdf`} target="_blank">PDF</a>
          </li>
        </ul>
      </div>

      {/* Dropdown menus are now available in the top navigation */}
    </div>
  )
}

export default Home
